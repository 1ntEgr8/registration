<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Admin - {{siteTitle}}</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<link rel="stylesheet" href="/css/wing-0.1.9.min.css" />
		<link rel="stylesheet" href="/node_modules/sweetalert2/dist/sweetalert2.min.css" />
		<link rel="stylesheet" href="/css/main.css" />
		<link rel="stylesheet" href="/css/admin.css" />
		<script src="/node_modules/es6-promise/dist/es6-promise.auto.min.js"></script>
		<script src="/node_modules/whatwg-fetch/fetch.js"></script>
		<script src="/node_modules/sweetalert2/dist/sweetalert2.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
		<script src="https://use.fontawesome.com/efaca8fe24.js"></script>
		<script src="https://d3js.org/d3.v3.min.js"></script>
		<script src="/js/common.js"></script>
		<script src="/js/admin.js" defer></script>
		<script src="/js/bargraph.js"></script>
	</head>
	<body>
		{{#> sidebar}}
			<h1 class="center">Admin Panel</h1>

			<nav class="row center">
				<a href="#statistics" class="btn">Statistics</a>
				<a href="#users" class="btn">Users</a>
				<a href="#settings" class="btn">Settings</a>
				<a href="#applicants" class="btn">Applicants</a>
			</nav>

			<section id="statistics">
				<h2>Statistics</h2>
				<table>
					<thead>
						<th colspan="2">Users</th>
					</thead>
					<tbody>
						<tr>
							<td>Total users</td>
							<td>{{numberFormat applicationStatistics.totalUsers}}</td>
						</tr>
						<tr>
							<td>Applied users</td>
							<td>{{numberFormat applicationStatistics.appliedUsers}}</td>
						</tr>
						<tr>
							<td>Admitted users</td>
							<td>{{numberFormat applicationStatistics.admittedUsers}}</td>
						</tr>
						<tr>
							<td>Attending users</td>
							<td>{{numberFormat applicationStatistics.attendingUsers}}</td>
						</tr>
						<tr>
							<td>Declined users</td>
							<td>{{numberFormat applicationStatistics.declinedUsers}}</td>
						</tr>
					</tbody>
				</table>
				<table>
					<thead>
						<th colspan="2">Application Statistics</th>
					</thead>
						{{#each generalStatistics}}
							<tr>
								<td>
									<div id="chart-{{@index}}">
										<h5>{{this.questionName}} ({{this.branch}})</h5>

									</div>

									<script>
										drawBarGraph({{{toJSONString this}}}, "chart-{{@index}}");
									</script>

								</td>
							</tr>
						{{/each}}
				</table>
			</section>
			<section id="users">
				<h2>Users</h2>
				<table>
					<thead>
						<th>Name</th>
						<th>Email</th>
						<th>Status</th>
						<th>Log in method</th>
					</thead>
					<tbody>
						{{#each users}}
							<tr>
								<td>{{this.name}}</td>
								<td>
									{{this.email}}
									{{#if this.verifiedEmail}}
										<i class="fa fa-check" aria-hidden="true"></i>
									{{else}}
										<i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
									{{/if}}
									{{#if this.admin}}
										<i class="fa fa-asterisk" aria-hidden="true"></i>
									{{/if}}
								</td>
								<td>{{this.status}}</td>
								<td>{{this.loginMethods}}</td>
							</tr>
						{{/each}}
					</tbody>
				</table>
			</section>
			<section id="settings">
				<h2>Settings</h2>

				<form method="post" data-action="/">
					<div class="row">
						<div class="col-6">
							<label for="application-open">Applications open:</label>
							<input id="application-open" type="datetime-local" data-raw-value="{{settings.application.open}}" required />
						</div>
						<div class="col-6">
							<label for="application-close">Applications close:</label>
							<input id="application-close" type="datetime-local" data-raw-value="{{settings.application.close}}" required />
						</div>
					</div>
					<div class="row">
						<div class="col-12">
							<label for="teams-enabled">Enable teams?</label>
							<input id="teams-enabled" type="checkbox" {{settings.teamsEnabledChecked}} />
						</div>
					</div>
					<div class="row center">
						<input type="submit" class="btn" value="Update" />
					</div>
				</form>
			</section>
			<section id="applicants">
				<h2>Applicants</h2>
				<div class="center">
					<a href="/api/user/all/export" class="btn">Export for check in</a>
				</div>
				<table>
					<thead>
						<th>Name</th>
						<th>Team</th>
						<th>Email</th>
						<th>Applicant type</th>
						<th>
							<select id="branchFilter">
								<!--todo, make this prettier-->
								<option value="*">All types</option>
								{{#each branchNames}}
									<option value="{{this}}">{{this}}</span>
								{{/each}}
							</select>
						</th>
						<th>
							<select id="acceptedFilter">
								<!--todo, make this prettier-->
								<option value="accepted-false">Not accepted</option>
								<option value="accepted-true">Accepted</option>
								<option value="*">All</option>
							</select>
						</th>
					</thead>
					<tbody>
						{{#each users}}
							{{#if this.applied}}
								<!--maybe query for each applied instead-->
								<tr class="{{this.applicationBranch}} accepted-{{this.accepted}} applicantDiv">
									<td><b>{{this.name}}</b></td>
									<td>
										{{#if this.teamName}}
											<b class="teamName">{{this.teamName}}</b>
										{{else}}
											No Team
										{{/if}}
									</td>
									<td>
										{{this.email}}
									</td>
									<td>
										{{this.applicationBranch}}
									</td>
									<td colspan="2">
										<!--not sure if there's a better way to do it than bind id to button id-->
										<button data-admin="{{../user.id}}" data-user="{{this._id}}" data-accepted="{{this.accepted}}" class="statusButton accepted-btn-{{this.accepted}}">
											
											{{#if this.accepted}}
												Un-Accept
											{{else}}
												Accept
											{{/if}}

										</button>
									</td>
								</tr>
								<tr class="{{this.applicationBranch}} accepted-{{this.accepted}} applicantDiv">
									<td colspan="5">
										<div class="applicantData">
											{{#each this.applicationDataFormatted}}
												<p><b>{{this.label}}</b> &rarr; {{this.value}}</p>
											{{/each}}
										</div>
									</td>
								</tr>
								
							{{/if}}
						{{/each}}
					</tbody>
				</table>
			</section>
		{{/sidebar}}
	</body>
</html>
