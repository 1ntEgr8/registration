<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Admin - {{siteTitle}}</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<link rel="stylesheet" href="/css/wing-0.1.9.min.css" />
		<link rel="stylesheet" href="/node_modules/sweetalert2/dist/sweetalert2.min.css" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css" />
		<link rel="stylesheet" href="/css/main.css" />
		<link rel="stylesheet" href="/css/admin.css" />
		<link rel="stylesheet" href="/css/theme.css" />
		<script src="/node_modules/es6-promise/dist/es6-promise.auto.min.js"></script>
		<script src="/node_modules/whatwg-fetch/fetch.js"></script>
		<script src="/node_modules/sweetalert2/dist/sweetalert2.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
		<script src="https://use.fontawesome.com/efaca8fe24.js"></script>
		<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
		<script src="/js/common.js"></script>
		<script>
			window.data = [
				{{#each generalStatistics}}
					{{{toJSONString this}}},
				{{/each}}
			];
		</script>
		<script src="/js/admin.js" defer></script>
	</head>
	<body>
		{{#> sidebar}}
			<h1 class="center">Admin Panel</h1>

			<nav class="row center">
				<a href="#statistics" class="btn">Statistics</a>
				<a href="#users" class="btn">Users</a>
				<a href="#applicants" class="btn">Applicants</a>
				<a href="#settings" class="btn">Settings</a>
			</nav>

			<section id="statistics">
				<h2>Statistics</h2>
				<table>
					<thead>
						<tr><th colspan="2">Users</th></tr>
					</thead>
					<tbody>
						<tr>
							<td>Total users</td>
							<td>{{numberFormat applicationStatistics.totalUsers}}</td>
						</tr>
						<tr>
							<td>Applied users</td>
							<td>{{numberFormat applicationStatistics.appliedUsers}}</td>
						</tr>
						<tr>
							<td>Admitted users</td>
							<td>{{numberFormat applicationStatistics.admittedUsers}}</td>
						</tr>
						<tr>
							<td>Attending users</td>
							<td>{{numberFormat applicationStatistics.attendingUsers}}</td>
						</tr>
						<tr>
							<td>Declined users</td>
							<td>{{numberFormat applicationStatistics.declinedUsers}}</td>
						</tr>
					</tbody>
				</table>
				<table>
					<thead>
						<tr><th colspan="2">Application Statistics</th></tr>
					</thead>
					<tbody>
						{{#each generalStatistics}}
							<tr>
								<td>
									<h5>{{this.questionName}} ({{this.branch}})</h5>
									<canvas id="chart-{{@index}}"></canvas>
								</td>
							</tr>
						{{/each}}
					</tbody>
				</table>
			</section>
			<section id="users">
				<h2>Users</h2>
				<table>
					<thead>
						<th>Name</th>
						<th>Email</th>
						<th>Status</th>
						<th>Log in method</th>
					</thead>
					<tbody>
						{{#each users}}
							<tr>
								<td>{{this.name}}</td>
								<td>
									{{this.email}}
									{{#if this.verifiedEmail}}
										<i class="fa fa-check" aria-hidden="true"></i>
									{{else}}
										<i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
									{{/if}}
									{{#if this.admin}}
										<i class="fa fa-asterisk" aria-hidden="true"></i>
									{{/if}}
								</td>
								<td>{{this.status}}</td>
								<td>{{this.loginMethods}}</td>
							</tr>
						{{/each}}
					</tbody>
				</table>
			</section>
			<section id="applicants">
				<h2>Applicants</h2>
				<div class="center">
					<a href="/api/user/all/export" class="btn">Export for check in</a>
					<button id="send-acceptances">Send acceptance emails</button>
				</div>
				<table>
					<thead>
						<th>Name</th>
						<th>Team</th>
						<th>Email</th>
						<th>Applicant type</th>
						<th>
							<select id="branchFilter">
								<!--todo, make this prettier-->
								<option value="*">All types</option>
								{{#each branchNames}}
									<option value="{{this}}">{{this}}</span>
								{{/each}}
							</select>
						</th>
						<th>
							<select id="acceptedFilter">
								<!--todo, make this prettier-->
								<option value="accepted-false">Not accepted</option>
								<option value="accepted-true">Accepted</option>
								<option value="*">All</option>
							</select>
						</th>
					</thead>
					<tbody>
						{{#each users}}
							{{#if this.applied}}
								<!--maybe query for each applied instead-->
								<tr class="{{this.applicationBranch}} accepted-{{this.accepted}} applicantDiv">
									<td><b>{{this.name}}</b></td>
									<td>
										{{#if this.teamName}}
											<b class="teamName">{{this.teamName}}</b>
										{{else}}
											No Team
										{{/if}}
									</td>
									<td>
										{{this.email}}
									</td>
									<td>
										{{this.applicationBranch}}
									</td>
									<td colspan="2">
										<!--not sure if there's a better way to do it than bind id to button id-->
										<button data-admin="{{../user.id}}" data-user="{{this._id}}" data-accepted="{{this.accepted}}" class="statusButton accepted-btn-{{this.accepted}}">
											
											{{#if this.accepted}}
												Un-Accept
											{{else}}
												Accept
											{{/if}}

										</button>
									</td>
								</tr>
								<tr class="{{this.applicationBranch}} accepted-{{this.accepted}} applicantDiv">
									<td colspan="5">
										<div class="applicantData">
											{{#each this.applicationDataFormatted}}
												{{#if this.filename}}
													<p><b>{{this.label}}</b> &rarr; {{this.value}} (<a href="/uploads/{{this.filename}}">Download</a>)</p>
												{{else}}
													<p><b>{{this.label}}</b> &rarr; {{this.value}}</p>
												{{/if}}
											{{/each}}
										</div>
									</td>
								</tr>
								
							{{/if}}
						{{/each}}
					</tbody>
				</table>
			</section>
			<section id="settings">
				<h2>Settings</h2>

				<form method="post" data-action="/">
					<div class="row">
						<div class="col-6">
							<label for="application-open">Applications open:</label>
							<input id="application-open" type="datetime-local" data-raw-value="{{settings.application.open}}" required />
						</div>
						<div class="col-6">
							<label for="application-close">Applications close:</label>
							<input id="application-close" type="datetime-local" data-raw-value="{{settings.application.close}}" required />
						</div>
					</div>
					<div class="row">
						<div class="col-6">
							<label for="confirmation-open">Confirmations open:</label>
							<input id="confirmation-open" type="datetime-local" data-raw-value="{{settings.confirmation.open}}" required />
						</div>
						<div class="col-6">
							<label for="confirmation-close">Confirmations close:</label>
							<input id="confirmation-close" type="datetime-local" data-raw-value="{{settings.confirmation.close}}" required />
						</div>
					</div>
					<div class="row">
						<div class="col-12">
							<label for="teams-enabled">Enable teams?</label>
							<input id="teams-enabled" type="checkbox" {{settings.teamsEnabledChecked}} />
						</div>
					</div>
					<div class="row">
						{{#each branchNames}}
							<div class="col-4 branch-role" data-name="{{this}}">
								<h4>{{this}}</h4>
								<select>
									<option value="noop" {{roleSelected ../settings.branchRoles "noop" this}}>Not used</option>
									<option value="application" {{roleSelected ../settings.branchRoles "application" this}}>Application</option>
									<option value="confirmation" {{roleSelected ../settings.branchRoles "confirmation" this}}>Confirmation</option>
								</select>
							</div>
						{{/each}}
					</div>
					<div class="row">
						<div class="col-12">
							<h4>Edit email content</h4>
							<p>Email content is written in <a href="https://daringfireball.net/projects/markdown/" target="_blank">Markdown</a>. A text version of email content will also be generated automatically. Valid HTML is also valid Markdown and can be useful for more complex layouts or styles. Interpolated variables will have any possible HTML tags or entities escaped. To prevent <code>&lt;style&gt;</code> blocks from affecting the rest of the page, use a browser that supports the <a href="https://caniuse.com/#search=shadow%20dom" target="_blank">Shadow DOM</a> like Chrome, Opera, or Safari.</p>
							<select id="email-type">
								<optgroup label="Application branches">
									{{#each settings.branchRoles.applicationBranches}}
										<option value="{{this}}-apply">{{this}} Post-Apply Email</option>
										<option value="{{this}}-accept">{{this}} Accepted Email</option>
									{{/each}}
								</optgroup>
								<optgroup label="Confirmation branches">
									{{#each settings.branchRoles.confirmationBranches}}
										<option value="{{this}}-attend">{{this}} Post-Confirm Email</option>
									{{/each}}
								</optgroup>
							</select>
							<textarea id="email-content"></textarea>
							<h5>Rendered HTML and text:</h5>
							<section id="email-rendered"></section>
							<h5>List of variables:</h5>
							<ul>
								<li><strong>\{{eventName}}</strong>: The name of the event, configured by the <code>eventName</code> key-value pair in the <code>config.json</code> and displayed at the top of the page.</li>
								<li><strong>\{{email}}</strong>: The user's email as reported by them or a 3rd party OAuth provider (i.e. Google, GitHub, Facebook).</li>
								<li><strong>\{{name}}</strong>: The user's name as reported by them or a 3rd party OAuth provider (i.e. Google, GitHub, Facebook).</li>
								<li><strong>\{{teamName}}</strong>: The user's team name if teams are enabled and the user has joined a team. Otherwise, will output <code>Teams not enabled</code> or <code>No team created or joined</code> respectively.</li>
								<li><strong>\{{applicationBranch}}</strong>: The question branch name that the user applied / was accepted to.</li>
								<li><strong>\{{confirmationBranch}}</strong>: The question branch name that the user RSVPed to.</li>
								<li><strong>\{{application.<code>question-name</code>}}</strong>: Prints the user's response to the application question with the specified name from <code>questions.json</code>. Note that the question name is different from the question label. <a href="https://github.com/HackGT/registration/blob/master/server/config/questions.json" target="_blank">See the GitHub project</a> for details. Will print <code>N/A</code> if not yet answered.</li>
								<li><strong>\{{confirmation.<code>question-name</code>}}</strong>: Prints the user's response to the confirmation question with the specified name from <code>questions.json</code>.</li>
							</ul>
						</div>
					</div>
					<h4><code>config.json</code> options</h4>
					<div class="row">
						<div class="col-4">
							<label>Event name:</label>
							<input type="text" value="{{config.eventName}}" disabled />
						</div>
						<div class="col-4">
							<label>Max team size:</label>
							<input type="text" value="{{config.maxTeamSize}}" disabled />
						</div>
						<div class="col-4">
							<label>Storage engine:</label>
							<input type="text" value="{{config.storageEngine}}" disabled />
						</div>
					</div>
					<div class="row">
						<div class="col-6">
							<label>Upload directory (from <code>config.json</code>):</label>
							<input type="text" value="{{config.uploadDirectoryRaw}}" disabled />
						</div>
						<div class="col-6">
							<label>Upload directory (resolved):</label>
							<input type="text" value="{{config.uploadDirectoryResolved}}" disabled />
						</div>
					</div>
					<div class="row">
						<div class="col-12">
							<label>Admins:</label>
							<textarea disabled>{{config.admins}}</textarea>
						</div>
					</div>

					<div class="row center">
						<input type="submit" class="btn" value="Update" />
					</div>
				</form>
			</section>
		{{/sidebar}}
	</body>
</html>
